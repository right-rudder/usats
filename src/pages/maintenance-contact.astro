---
import BaseLayout from "../layouts/BaseLayout.astro";
import { IoPhonePortraitOutline, IoLocationOutline } from "react-icons/io5";
import { TfiEmail } from "react-icons/tfi";
import contact from "../data/contact";
import { AIRCRAFT_FLEET_KEYWORDS, AVIATION_SERVICES_KEYWORDS, COMPANY_NAME, GENERAL_AVIATION_KEYWORDS, LOCATION_KEYWORDS } from "../consts";
import Header from "../components/astro/Header.astro";
import UnderHeaderTwo from "../components/astro/UnderHeaderTwo.astro";

const { data } = contact;
const MAINTENANCE_CONTACT_FORM_WEBHOOK_URL = import.meta.env
  .MAINTENANCE_CONTACT_FORM_WEBHOOK_URL;
const PORTAL_API_KEY = import.meta.env.PORTAL_API_KEY;

const headerData = {
  headerH1: "MAINTENANCE USATS",
  imagePath: "/src/assets/placeholder-USATS-titusville-aviation-academy-florida.webp",
  imageAlt: "",
};

const maintenanceContact = {
  siteTitle: `Contact Our Maintenance | ${COMPANY_NAME}`,
  siteDescription: "Contact USATS Maintenance to schedule aircraft inspections, repairs, or support services in Titusville, FL. Our certified maintenance team is ready to assist with reliable, safety-focused aviation solutions for students, owners, and operators."
}

const underHeader = {
  title: "Trusted Maintenance Support for Every Aircraft",
  paragraphs: [
    "Our maintenance team is committed to delivering dependable service for pilots, owners, and operators who rely on precision and consistency. Every inspection, repair, and diagnostic task is handled by certified technicians who follow strict FAA standards to protect the performance and safety of your aircraft. We work with attention to detail and clear communication so you always understand the condition of your airplane or helicopter and the steps required to keep it operating at its best.",
    "Whether you need scheduled maintenance, troubleshooting, or a last minute repair, our facility gives you access to the tools, equipment, and expertise required to keep your aircraft airworthy and mission ready. By submitting the maintenance request form, you connect directly with a team that values quality work, quick turnaround times, and reliable support. We are here to help you stay safe, stay compliant, and stay flying with total confidence."
  ],
  image: {
    imagePath: "/src/assets/alto_ng-USATS-titusville-professional-pilot-program.webp",
    imageAlt: "Aircraft panel showing modern avionics",
  },
  buttons: [],
};
const keywords = `${AVIATION_SERVICES_KEYWORDS}, ${AIRCRAFT_FLEET_KEYWORDS}, ${GENERAL_AVIATION_KEYWORDS}, ${LOCATION_KEYWORDS}`;

---

<BaseLayout
  siteTitle={maintenanceContact.siteTitle}
  siteDescription={maintenanceContact.siteDescription}
  keywords={keywords}>
  <Header data={headerData} />
  <section
    class="py-30 relative isolate bg-gradient-to-b from-primary-950 to-primary-800"
    id="contact-us"
  >
    <div class="mx-auto grid max-w-7xl grid-cols-1 lg:grid-cols-2">
      <div
        class="relative px-6 pb-20 pt-24 sm:pt-32 lg:static lg:px-8 lg:py-48"
      >
        <div class="mx-auto max-w-xl lg:mx-0 lg:max-w-lg">
          <h2
            class="text-pretty text-4xl font-bold font-sans tracking-tight text-red-700 lg:text-6xl"
          >
            Get in touch
          </h2>
          <p class="mt-6 text-lg/8 text-muted-400 font-parag">
            {data.description}
          </p>
          <dl
            class="mt-10 space-y-4 text-base/7 text-muted-400 font-bold font-sans2"
          >
            <div class="flex gap-x-4">
              <dt class="flex-none">
                <IoLocationOutline />
              </dt>
              <dd>
                <a
                  class="hover:text-white hover:underline"
                  href={data.locations[0].gMaps}
                >
                  {data.locations[0].address}<br />
                  {data.locations[0].city}, {data.locations[0].state}
                  {data.locations[0].zip}
                </a>
              </dd>
            </div>
            <div class="flex gap-x-4">
              <dt class="flex-none">
                <IoPhonePortraitOutline />
              </dt>
              <dd>
                <a
                  class="hover:text-white hover:underline"
                  href={`tel:${data.locations[0].phone}`}
                  >{data.locations[0].phone}</a
                >
              </dd>
            </div>
            <!-- <div class="flex gap-x-4">
              <dt class="flex-none">
                <TfiEmail />
              </dt>
              <dd>
                <a class="hover:text-white" href={`mailto:${data.email}`}>{data.email}</a>
              </dd>
            </div> -->
          </dl>
        </div>
      </div>
      <div class="px-12 py-32 bg-primary-900">
        <form id="contact-form" class="w-full text-white">
          <div class="mb-4">
            <label for="first-name" class="block font-semibold"
              >First Name</label
            >
            <input
              type="text"
              id="first-name"
              name="first-name"
              autocomplete="given-name"
              class="w-full h-9 p-2 border text-muted-900 bg-white border-gray-400 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
              required
            />
          </div>
          <div class="mb-4">
            <label for="last-name" class="block font-semibold">Last Name</label>
            <input
              type="text"
              id="last-name"
              name="last-name"
              autocomplete="family-name"
              class="w-full h-9 p-2 border text-muted-900 bg-white border-gray-400 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
              required
            />
          </div>
          <div class="mb-4">
            <label for="phone" class="block font-semibold">Phone</label>
            <input
              type="text"
              id="phone"
              name="phone"
              autocomplete="tel"
              class="w-full h-9 p-2 border text-muted-900 bg-white border-gray-400 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
              required
            />
          </div>
          <div class="mb-4">
            <label for="email" class="block font-semibold">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              autocomplete="email"
              class="w-full h-9 p-2 border text-muted-900 bg-white border-gray-400 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
              required
            />
          </div>
          <div class="mb-4">
            <label for="aircraft-make" class="block font-semibold"
              >Aircraft Manufacturer</label
            >
            <input
              type="text"
              id="aircraft-make"
              name="aircraft-make"
              class="w-full h-9 p-2 border bg-white text-muted-900 border-gray-400 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
              required
            />
          </div>
          <div class="mb-4">
            <label for="aircraft-model" class="block font-semibold"
              >Aircraft Model</label
            >
            <input
              type="text"
              id="aircraft-model"
              name="aircraft-model"
              class="w-full h-9 p-2 border bg-white text-muted-900 border-gray-400 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
              required
            />
          </div>
          <div class="mb-4">
            <label for="n-number" class="block font-semibold"
              >Aircraft N-Number</label
            >
            <input
              type="text"
              id="n-number"
              name="n-number"
              class="w-full h-9 p-2 border bg-white text-muted-900 border-gray-400 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
              required
            />
          </div>
          <div class="mb-4">
            <label for="message" class="block font-semibold"
              >How can we help you?</label
            >
            <textarea
              required
              name="message"
              id="message"
              rows="4"
              class="w-full p-2 border bg-white text-muted-900 border-accent-800 rounded-sm focus:outline focus:ring focus:border-primary-600/50"
            ></textarea>
          </div>
          <p class="hidden">
            <label>
              Don't fill this out if you're human:
              <input name="confirm-email" />
            </label>
          </p>
          <div class="mb-4">
            <input
              type="checkbox"
              name="agree-data-collection"
              id="agree-data-collection"
              class="mr-2 size-5"
            />
            <label
              for="agree-data-collection"
              class="text-muted-400 text-sm lg:text-base"
            >
              I agree to <a
                href="/terms-of-service"
                class="font-semibold hover:underline"
                target="_blank">terms of service</a
              > & <a
                href="/privacy-policy"
                class="font-semibold hover:underline"
                target="_blank">privacy policy</a
              >. By providing my phone number, I agree to receive text messages
              from the business.
            </label>
          </div>
          <button
            id="submit-button"
            form="contact-form"
            disabled
            type="submit"
            class="mx-auto mt-8 btn-primary cursor-not-allowed bg-gray-400 hover:bg-gray-800 hover:text-white"
          >
            Send Message
          </button>
        </form>
      </div>
    </div>

    <!-- Background Pattern -->
    <div class="absolute inset-0 -z-10 overflow-hidden">
      <svg
        class="absolute left-[max(50%,25rem)] top-0 h-[64rem] w-[128rem] -translate-x-1/2 stroke-black [mask-image:radial-gradient(64rem_64rem_at_top,white,transparent)]"
        aria-hidden="true"
      >
        <defs>
          <pattern
            id="e813992c-7d03-4cc4-a2bd-151760b470a0"
            width="200"
            height="200"
            x="50%"
            y="-1"
            patternUnits="userSpaceOnUse"
          >
            <path d="M100 200V.5M.5 .5H200" fill="none"></path>
          </pattern>
        </defs>
        <svg x="50%" y="-1" class="overflow-visible fill-primary-950">
          <path
            d="M-100.5 0h201v201h-201Z M699.5 0h201v201h-201Z M499.5 400h201v201h-201Z M-300.5 600h201v201h-201Z"
            stroke-width="0"></path>
        </svg>
        <rect
          width="100%"
          height="100%"
          stroke-width="0"
          fill="url(#e813992c-7d03-4cc4-a2bd-151760b470a0)"></rect>
      </svg>
    </div>
  </section>

  <UnderHeaderTwo content={underHeader}/>

  <script define:vars={{ MAINTENANCE_CONTACT_FORM_WEBHOOK_URL, PORTAL_API_KEY }}
  >
    const checkbox = document.getElementById("agree-data-collection");
    const submitButton = document.getElementById("submit-button");

    checkbox.addEventListener("change", function () {
      if (checkbox.checked) {
        submitButton.disabled = false;
        submitButton.classList.remove(
          "cursor-not-allowed",
          "bg-gray-400",
          "hover:bg-gray-400",
        );
      } else {
        submitButton.disabled = true;
        submitButton.classList.add(
          "cursor-not-allowed",
          "bg-gray-400",
          "hover:bg-gray-400",
        );
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("contact-form");
      if (!form) {
        console.error("Form element not found.");
        return;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(form);
        const confirmEmail = formData.get("confirm-email")?.trim();
        if (confirmEmail) return;

        const webhookURL = MAINTENANCE_CONTACT_FORM_WEBHOOK_URL;
        const apiKey = PORTAL_API_KEY;

        const urlEncodedBody = new URLSearchParams(formData).toString();

        const excludedFields = [
          "first-name",
          "last-name",
          "email",
          "phone",
          "confirm-email",
          "agree-data-collection",
        ];

        const metadata = {};

        for (const [key, value] of formData.entries()) {
          if (!excludedFields.includes(key)) {
            metadata[key] = value?.trim?.() ?? value;
          }
        }

        const jsonBody = {
          first_name: formData.get("first-name")?.trim() || "",
          last_name: formData.get("last-name")?.trim() || "",
          email: formData.get("email")?.trim() || "",
          phone: formData.get("phone")?.trim() || "",
          campaign: "maintenance",
          account_random_id: "ac_ad4sxcg0",
          metadata: metadata,
        };

        try {
          const [ghlRes, portalRes] = await Promise.all([
            fetch(webhookURL, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: urlEncodedBody,
            }),
            fetch("https://portal.rightruddermarketing.com/api/leads", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                "x-api-key": apiKey,
              },
              body: JSON.stringify(jsonBody),
            }),
          ]);

          if (ghlRes.ok && portalRes.ok) {
            window.location.href = "/contact-us-confirmation";
          } else {
            console.error("Submission failed", {
              ghlStatus: ghlRes.status,
              portalStatus: portalRes.status,
            });
          }
        } catch (err) {
          console.error("Submission error:", err);
        }
      });
    });
  </script>
  <!-- Prevent Multiple Submissions  -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector("form");
      if (form) {
        form.addEventListener("submit", function (e) {
          const submitBtn = form.querySelector<HTMLButtonElement>(
            "button[type='submit']",
          );
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerText = "Submitting...";
          }
        });
      }
    });
  </script>
  <script src="../scripts/emailValidation.js"></script>
</BaseLayout>
