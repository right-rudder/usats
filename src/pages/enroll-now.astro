---
import Header from "../components/astro/Header.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
import { COMPANY_NAME, COMPANY_NICKNAME } from "../consts";
const headerData = {
  headerH1: "START TODAY",
  imagePath: "/src/assets/placeholder.webp",
  imageAlt: "",
};

const checkboxText =
  `I agree to the Privacy Policy and Terms of Service provided by the company.
        By providing my phone number, I agree to receive text messages from the business. I also agree that I may be contacted via messaging apps such as WhatsApp or Signal.
      `;

const ENROLLMENT_FORM_WEBHOOK_URL = import.meta.env.ENROLLMENT_FORM_WEBHOOK_URL;
---

<BaseLayout
  siteTitle=`Enrollment Form | ${COMPANY_NAME}`
  siteDescription=`${COMPANY_NAME} USATS offers career-track, zero-to-hero pilot training programs at Space Coast Regional Airport (KTIX) in Titusville, Florida. With over 320 flying days per year, state-of-the-art facilities, and FAA-approved Part 141 and 61 programs, we provide top-tier education with flexible scheduling to fit the needs of aspiring airplane and helicopter pilots. Our comprehensive training, experienced instructors, and efficient course structure ensure students receive the highest quality instruction and flight experience to launch successful aviation careers`
  keywords=""
>
  <Header data={headerData} />

  <section class="bg-primary-900">
    <div class="max-w-3xl mx-auto py-24 px-9">
      <h2
        class="text-accent-900 text-center text-5xl font-extrabold mx-auto w-fit mb-5"
      >
        Start the enrollment process at <span class="text-accent-900"
          >{COMPANY_NAME}</span
        >
      </h2>
      <h3
        class="font-medium mt-4 mb-12 font-sans1 leading-tight text-muted-200 text-center mx-auto text-xl"
      >
        {`Fill out the form below and let's start flying! A ${COMPANY_NICKNAME} team member
        will get in touch with you and walk you through the next steps on
        getting you in the air.`}
      </h3>
      <form
        id="enrollment-form"
        class="flex flex-col max-w-4xl mx-auto gap-3 my-5"
      >
        <div class="flex flex-col lg:flex-row gap-5">
          <input
            type="text"
            name="first-name"
            placeholder="Your first name"
            class="px-5 py-4 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
          <input
            type="text"
            name="last-name"
            placeholder="Your last name"
            class="px-5 py-4 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
        </div>
        <div class="flex flex-col lg:flex-row gap-5">
          <input
            type="email"
            name="email"
            id="email"
            placeholder="Your email"
            class="px-5 py-4 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
          <input
            type="email"
            name="confirm-email"
            placeholder="Confirm email"
            class="hidden px-5 py-4 outline-1 w-full border-gray-400 border outline-gray-500"
          />
          <input
            type="tel"
            name="phone"
            placeholder="Your phone number"
            class="px-5 py-4 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
        </div>

        <fieldset class="flex flex-col justify-center items-center align-middle mt-6">
          <legend class="mb-2 text-xl font-semibold text-muted-300 text-center w-full">
            Which aircraft type are you interested in? <span class="text-red-500">*</span>
          </legend>
          <div class="flex gap-6">
            <div class="flex items-center gap-2">
              <input
                type="radio"
                id="airplane-type"
                name="aircraft-type"
                value="Airplane"
                required
                class="w-4 h-4 text-accent-800 focus:ring-accent-900"
              />
              <label for="airplane-type" class="text-muted-300">Airplane</label>
            </div>
            <div class="flex items-center gap-2">
              <input
                type="radio"
                id="helicopter-type"
                name="aircraft-type"
                value="Helicopter"
                required
                class="w-4 h-4 text-accent-800 focus:ring-accent-900"
              />
              <label for="helicopter-type" class="text-muted-300">Helicopter</label>
            </div>
          </div>
        </fieldset>
        
        <!-- Dynamic Program Options -->
        <fieldset class="flex flex-col justify-center items-center align-middle mt-4">
          <legend class="mb-2 text-muted-300 text-xl font-semibold text-center w-full">
            Primary Training Program Interest? <span class="text-red-500">*</span>
          </legend>
          <div id="program-options-container" class="hidden flex flex-col gap-2">
            <!-- Options will be populated by JavaScript -->
          </div>
        </fieldset>

        <label class="text-muted-300" class="mt-4 text-xl text-center font-semibold text-muted-300" for="experience"
          >How far along are you in pilot training?*</label
        >
        <input
          id="experience"
          name="experience"
          type="text"
          placeholder=""
          class="px-5 py-4 outline-1 w-full border-gray-400 border outline-gray-500"
          required
        />

        <!-- International Student -->
        <fieldset class="flex flex-col justify-center items-center align-middle mt-6">
          <legend class="mb-2 text-xl font-semibold text-muted-300 text-center w-full">
            Are you an International Student? <span class="text-red-500">*</span>
          </legend>
          <div class="flex gap-6">
            <div class="flex items-center gap-2">
              <input
                type="radio"
                id="international-student"
                name="international-student"
                value="international-student"
                required
                class="w-4 h-4 text-accent-800 focus:ring-accent-900"
              />
              <label for="international-student" class="text-muted-300">
                Yes, I'm an International Student
              </label>
            </div>
            <div class="flex items-center gap-2">
              <input
                type="radio"
                id="regular-student"
                name="international-student"
                value="regular-student"
                required
                class="w-4 h-4 text-accent-800 focus:ring-accent-900"
              />
              <label for="regular-student" class="text-muted-300">
                No, I'm an not
              </label>
              
            </div>
          </div>
          <span class="text-muted-400 text-sm pt-2 italic">By sumbiting this form you agree to receive information on WhatsApp or Signal*</span>
        </fieldset>
                
        <label
          for="extra-information"
          class="mt-6 text-xl text-center font-semibold text-muted-300"
          >Anything else you want us to know about?*</label
        >
        <textarea
          required
          id="extra-information"
          name="extra-information"
          placeholder=""
          rows="5"
          class="px-5 py-4 outline-1 border-gray-400 border outline-gray-500"
        ></textarea>
        
        <div class="">
          <label
            for="agree-data-collection"
            class="text-gray-500 font-sans text-sm lg:text-base mt-4 w-full inline-flex items-center"
          >
            <input
              type="checkbox"
              name="agree-data-collection"
              id="agree-data-collection"
              class="mr-3 w-5 h-5"
            />
            {checkboxText}
          </label>
        </div>
        <div class="flex justify-center">
          <button
            id="submit-button"
            disabled
            type="submit"
            class="btn-primary bg-accent-900 mt-12 cursor-not-allowed hover:bg-accent-700"
            >Submit</button
          >
        </div>
      </form>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ ENROLLMENT_FORM_WEBHOOK_URL }}>
  const trainingPrograms = {
    Airplane: [
      { value: "private-pilot-license", text: "Private Pilot License" },
      { value: "instrument-rating", text: "Instrument Rating" },
      { value: "instrument-proficiency-check", text: "Instrument Proficiency Check" },
      { value: "commercial-pilot-license", text: "Commercial Pilot License" },
      { value: "cfi", text: "Flight Instructor (CFI)" },
      { value: "cfii", text: "Flight Instructor Instrument (CFII)" },
      { value: "professional-pilot-program", text: "Professional Pilot Program" },
    ],
    Helicopter: [
      { value: "private-pilot-license-h", text: "Private Pilot License- Helicopter" },
      { value: "instrument-rating-h", text: "Instrument Rating - Helicopter" },
      { value: "instrument-proficiency-check-h", text: "Instrument Proficiency Check- Helicopter" },
      { value: "commercial-pilot-license-h", text: "Commercial Pilot License - Helicopter" },
      { value: "cfi-h", text: "Flight Instructor - Helicopter" },
      { value: "cfii-h", text: "Flight Instructor Instrument - Helicopter" },
      { value: "professional-pilot-program-h", text: "Professional Pilot Program - Helicopter" },
      { value: "military-transition", text: "Military Transition Training" },
    ]
  };

  function updateProgramOptions(selectedType) {
    const container = document.getElementById("program-options-container");
    container.innerHTML = '';
    
    const programs = trainingPrograms[selectedType];
    if (programs) {
      programs.forEach(program => {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-2';
        wrapper.innerHTML = `
          <input
            type="radio"
            class="mx-2 text-accent-800 focus:ring-accent-900"
            id="${program.value}"
            name="interest"
            value="${program.value}"
            required
          />
          <label class="text-muted-300" for="${program.value}">${program.text}</label>
        `;
        container.appendChild(wrapper);
      });
      container.classList.remove('hidden');
    } else {
      container.classList.add('hidden');
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const aircraftTypeRadios = document.querySelectorAll('input[name="aircraft-type"]');
    aircraftTypeRadios.forEach(radio => {
      radio.addEventListener('change', (event) => {
        updateProgramOptions(event.target.value);
      });
    });

    const container = document.getElementById("program-options-container");
    container.classList.add('hidden');

    const enrollmentForm = document.getElementById("enrollment-form");
    const checkbox = document.getElementById("agree-data-collection");
    const submitButton = document.getElementById("submit-button");
    // const yesVisit = document.getElementById("yes-visit");
    // const noVisit = document.getElementById("no-visit");

    // yesVisit.addEventListener("change", function () {
    //   if (yesVisit.checked) {
    //     document.getElementById("location-container").classList.remove("hidden");
    //     document.getElementById("location-container").classList.add("flex");
    //   }
    // });

    // noVisit.addEventListener("change", function () {
    //   if (noVisit.checked) {
    //     document.getElementById("location-container").classList.add("hidden");
    //   }
    // });

    checkbox.addEventListener("change", function () {
      if (checkbox.checked) {
        submitButton.disabled = false;
        submitButton.classList.remove(
          "cursor-not-allowed",
          "bg-gray-400",
          "hover:bg-gray-500",
          "bg-primary"
        );
      } else {
        submitButton.disabled = true;
        submitButton.classList.add(
          "btn-primary",
          "cursor-not-allowed",
          "bg-gray-400",
          "hover:bg-gray-500"
        );
      }
    });

    if (enrollmentForm !== null) {
      enrollmentForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(enrollmentForm);

        const aircraftType = formData.get("aircraft-type");
        if (!aircraftType) {
          alert("Please select an aircraft type");
          return;
        }

        const programInterest = formData.get("interest");
        if (!programInterest) {
          alert("Please select a training program");
          return;
        }

        const confirmEmailValue = formData.get("confirm-email");
        if (confirmEmailValue === "" || confirmEmailValue === null) {
          enrollmentForm.action = ENROLLMENT_FORM_WEBHOOK_URL;
        }

        const urlSearchParams = new URLSearchParams();
        for (const pair of formData.entries()) {
          urlSearchParams.append(pair[0], pair[1]);
        }

        const xhr = new XMLHttpRequest();
        xhr.open("POST", enrollmentForm.action);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        xhr.onload = function () {
          if (xhr.status === 200) {
            window.location.href = "/enroll-now-confirmation";
          } else {
            console.error("Form submission failed:", xhr.statusText);
          }
        };
        xhr.onerror = function () {
          console.error("Network error occurred while submitting the form.");
        };
        xhr.send(urlSearchParams);
      });
    }
  });
</script>

<script src="../scripts/emailValidation.js"></script>